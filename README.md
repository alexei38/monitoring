# Системный мониторинг

![GitHub CI](https://github.com/alexei38/monitoring/actions/workflows/build.yml/badge.svg?branch=monitoring)

Программа, предназначена для сбора агрегированной статистики с сервера и отправки клиенту по протоколу GRPC  

Агрегированная статистика - это среднее арифметическое число результата нескольких метрик


## Поддерживаемые ОС

- Linux
- Windows
- Macos

## Поддерживаемые метрики

- CPU
- Load Average

## Сборка

Для сборки сервера можно использовать утилиту make

**Сборка бинарного файла**
```bash
make build
```
В результате в каталоге ./bin/ появится исполняемый файл monitoring

**Сборка docker образа**
```bash
make build-img
```
В результате будет создан docker образ monitoring:develop

## Сервер

При подключении клиента, начинает сбор статистики.

Принимает пакет grpc от клиента
```protobuf
message ClientRequest {
  int32 interval = 1;
  int32 counter = 2;
}
```
**interval** - интервал в секундах, через какой промежуток времени клиент будет получать агрегированные метрики

**counter** - счетчик, сколько минимум сообщений метрик должно накопиться, перед тем как начать агрегирование и отправку клиенту

### Настройка сервера

Для настройки используется конфигурационный файл в формате yaml либо параметры запуска

Конфигурационный файл, может находиться в следующих каталогах по приоритету:

- /etc/monitoring/config.yaml
- $HOME/.monitoring/config.yaml
- ./configs/config.yaml
- ./config.yaml

Стандартный конфиг:
```yaml
---
listen:
  host: 127.0.0.1 # какой ip слушать
  port: 9080      # какой порт слушать
metrics:          # секция по включению/отключению метрик
  cpu: true       # включить/выключить сбор cpu метрик
  load: true      # включить/выключить сбор load average метрик
logger:
  level: INFO     # лог левел. доступные значения DEBUG, INFO, WARN, ERROR
```

В качестве параметров запуска, можно передавать параметры при запуске сервера
```
./bin/monitoring server --help
--version - показать текущую версию
--host    - какой слушать ip (по умолчанию: 127.0.0.1)
--port    - какой слушать порт (по умолчанию: 9080)
--config  - путь до конфиг файла
```

### Запуск сервера

Запуск сервера осуществляется командой
```sh
./bin/monitoring server
```

Либо через Makefile

```bash
make run-server # запуск исполняемого файла
make run-img    # запуск в docker контейнере
```

## Клиент

Запуск клиента осуществляется командой
```
./bin/monitoring client
```

При запуске клиенту можно передать параметры
```
./bin/monitoring client --help
--interval  # интервал в секундах, как часто сервер будет отправлять метрики (по умолчанию: 5)
--counter   # счетчит, сколько нужно аггрегировать метрик серверу перед отправкой клиенту (по умолчанию: 15)
--host      # хост, куда подключаться (по умолчанию 127.0.0.1)
--port      # порт, куда подключаться (по умолчанию 9080)
```